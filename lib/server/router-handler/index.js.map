{"version":3,"sources":["../../../src/server/router-handler/index.js"],"names":["express","require","methodOverride","_","request","bodyParser","HandlerParser","default","initPlugins","module","exports","entry","handlerParser","HANDLER_PATH","DATA_PATH","handlerList","parseAndSave","router","Router","use","render","req","res","jsonp","locals","data","all","next","header","forEach","handlerData","METHOD","method","toLowerCase","ROUTE_PATH","route","paramsFromReferer","_m_name","_m_target","_m_disable","isDisable","matchedReferer","filter","item","name","query","body","curMockerData","getHandler","disable","isDisabled","handlerName","url","params","merge","getHandleModuleResultForHttp","then","result","append","extra","handlerInfo","handleModuleInfo","catch","err","errMsg","stack","console","error","status","send","isRequested","_m_from","opts","headers","host","jar","qs","get","on","response","pipe","post","form","_handlerParser"],"mappings":"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","file":"index.js","sourcesContent":["const express = require('express');\nconst methodOverride = require('method-override');\nconst _ = require('lodash');\nconst request = require('request');\nconst bodyParser = require('../body-parser');\nconst HandlerParser = require('../../parser/handler-parser').default;\nconst initPlugins = require('./plugins');\n\nmodule.exports = (entry) => {\n  const handlerParser = new HandlerParser(entry.HANDLER_PATH, entry.DATA_PATH);\n\n  let handlerList = handlerParser.parseAndSave();\n\n  // Create router\n  // http://expressjs.com/en/4x/api.html#router\n  const router = express.Router();\n\n  // Add middlewares\n  router.use(methodOverride());\n  router.use(bodyParser);\n\n  // Expose render\n  router.render = (req, res) => {\n    res.jsonp(res.locals.data);\n  };\n\n  initPlugins(router, handlerParser);\n\n  // 所有的请求都会经过这里，可以做一些类似权限控制的事情\n  router.all('*', function (req, res, next) {\n    res.header('Access-Control-Allow-Origin', '*');\n    next();\n  });\n\n  // 根据用户配置的路由关系，进行解析\n  // console.log('handlerList', handlerList);\n  handlerList.forEach((handlerData) => {\n    // 默认是 get 请求，除非定义 method 字段\n    const METHOD = (handlerData.method || 'get').toLowerCase();\n    const ROUTE_PATH = handlerData.route;\n\n    // http://expressjs.com/en/4x/api.html#router.METHOD\n    router[METHOD](ROUTE_PATH, function (req, res, next) {\n      // Express的req对象，详见 http://expressjs.com/en/4x/api.html#req\n\n      // post 请求\n      // handlerData.route=\"/cgi-bin/a/b/post_cgi\"\n      // post http://localhost:3000/cgi-bin/a/b/post_cgi data={activeModule:\"error_not_login\"}\n      // req.baseUrl=\"\"\n      // req.originalUrl=\"/cgi-bin/a/b/post_cgi\"\n      // req.url=\"/cgi-bin/a/b/post_cgi\"\n      // req.method=\"POST\"\n      // req.OriginalMethod=\"POST\"\n      // req.body.activeModule = \"error_not_login\"\n      // req.body = data\n\n      // get 请求\n      // handlerData.route=\"/cgi-bin/a/b/simple_cgi\"\n      // get http://localhost:3000/cgi-bin/a/b/simple_cgi?activeModule=error_not_login\n      // req.baseUrl=\"\"\n      // req.originalUrl=\"/cgi-bin/a/b/simple_cgi?activeModule=error_not_login\"\n      // req.url=\"/cgi-bin/a/b/simple_cgi?activeModule=error_not_login\"\n      // req.method=\"GET\"\n      // req.OriginalMethod=\"GET\"\n      // req.query.activeModule = \"error_not_login\"\n\n      // get 请求且route为匹配类型\n      // handlerData.route=\"/cgi-bin/a/b/id/:id\"\n      // get http://localhost:3000/cgi-bin/a/b/id/1?activeModule=error_not_login\n      // req.baseUrl=\"\"\n      // req.originalUrl=\"/cgi-bin/a/b/id/1?activeModule=error_not_login\"\n      // req.url=\"/cgi-bin/a/b/id/1?activeModule=error_not_login\"\n      // req.method=\"GET\"\n      // req.OriginalMethod=\"GET\"\n      // req.query.activeModule = \"error_not_login\"\n      // req.params.id = \"1\"\n\n      // console.log(req.headers.referer)\n      // 目前只支持 plugin=mocker 的场景，_m_name=该模块的名字，_m_target=该模块的值对应的名字,_m_disable\n      let paramsFromReferer = [{\n        _m_name: 'demo_simple11',\n        _m_target: 'success',\n        _m_disable: 0\n      }];\n\n      let isDisable;\n\n      // 判断该路由的名字是否在referer中\n      let matchedReferer = paramsFromReferer.filter((item) => {\n        return item._m_name === handlerData.name;\n      })[0];\n\n      if (matchedReferer) {\n        // referer 里面的请求参数拥有最高优先级，因为这种场景比较特殊，主要用于自动化测试之用\n        isDisable = matchedReferer._m_disable;\n      } else {\n        // 从请求 req 或者 config.json 文件中检查当前请求是否需要禁用 handle 服务\n        isDisable = req.query._m_disable || req.body._m_disable;\n        if (!isDisable) {\n          // 此处要重新获取新的数据，以便取到缓存的。\n          // TODO 此处还可以优化，比如及时更新缓存中的数据，而不需要每次都去获取\n          let curMockerData = handlerParser.getHandler(handlerData.name, true);\n          isDisable = curMockerData.disable;\n        }\n      }\n\n      if (isDisable) {\n        // 如果当前禁用了 handle 服务，则不处理\n        res.locals.isDisabled = true;\n        res.locals.handlerName = handlerData.name;\n        next();\n      } else {\n        let url = ROUTE_PATH;\n        let params = (METHOD === 'post') ? req.body : req.query;\n\n        // 还要合并一下来自 url path 中的参数值\n        // referer 里面的请求参数拥有最高优先级，因为这种场景比较特殊，主要用于自动化测试之用\n        params = _.merge({}, params, req.params, matchedReferer);\n\n        // 请求\n        handlerParser.getHandleModuleResultForHttp(url, params, req)\n          .then((result) => {\n            res.append('matman-handler', result.extra.handlerInfo.name);\n            res.append('matman-handle-module', result.extra.handleModuleInfo.name);\n            res.jsonp(result.data);\n          })\n          .catch((err) => {\n            // 注意 err 有可能是 Error 对象，也可能是普通的字符串或对象\n            let errMsg = err.stack || err;\n\n            console.error(errMsg);\n\n            res.status(500).send(errMsg);\n          });\n      }\n\n    });\n  });\n\n  router.use((req, res) => {\n    // get 请求\n    // get http://localhost:3000/cgi-bin/a/b/not_exist_cgi?activeModule=error_not_login\n    // req.headers.host=\"localhost:3000\"\n    // req.params[0]=\"/cgi-bin/a/b/not_exist_cgi\"\n    // req.baseUrl=\"\"\n    // req.originalUrl=\"/cgi-bin/a/b/not_exist_cgi?activeModule=error_not_login\"\n    // req.url=\"/cgi-bin/a/b/not_exist_cgi?activeModule=error_not_login\"\n    // req.method=\"GET\"\n    // req.OriginalMethod=\"GET\"\n    // req.query.activeModule = \"error_not_login\"\n\n    // post 请求\n    // post http://localhost:3000/cgi-bin/a/b/not_exist_cgi data={activeModule:\"error_not_login\"}\n    // req.params[0]=\"/cgi-bin/a/b/not_exist_cgi\"\n    // req.baseUrl=\"\"\n    // req.originalUrl=\"/cgi-bin/a/b/not_exist_cgi\"\n    // req.url=\"/cgi-bin/a/b/not_exist_cgi\"\n    // req.method=\"POST\"\n    // req.OriginalMethod=\"POST\"\n    // req.body.activeModule = \"error_not_login\"\n\n    // 未匹配到的请求将会来到这里\n    // console.log('[use]', req.url, req.query._m_from);\n\n    // 判断是否已经是第二次请求了。\n    // 请求本地服务的时候，可能会陷入死循环中，因此此处校验最多只请求一次。\n    const isRequested = !!req.query._m_from;\n\n    const opts = {\n      url: 'http://' + req.headers.host + req.url,\n      headers: req.headers,\n      jar: true,\n      // timeout: 4000,\n      qs: {\n        _m_from: 1\n      }\n    };\n\n    if (res.locals.isDisabled) {\n      res.append('matman-disable', res.locals.handlerName);\n    }\n\n    if (req.method === 'GET' && !isRequested) {\n      request\n        .get(_.merge({}, opts))\n        .on('response', function (response) {\n          // console.log(response.statusCode) // 200\n        })\n        .on('error', function (err) {\n          console.error(err);\n          res.status(500).send(err.stack);\n        })\n        .pipe(res);\n    } else if (req.method === 'POST' && !isRequested) {\n      request\n        .post(_.merge({}, opts, {\n          form: req.body\n        }))\n        .on('response', function (response) {\n          // console.log(response.statusCode)\n        })\n        .on('error', function (err) {\n          console.error(err);\n          res.status(500).send(err.stack);\n        })\n        .pipe(res);\n    } else {\n      if (!res.locals.data) {\n        res.status(404);\n        res.locals.data = {};\n      }\n\n      router.render(req, res);\n    }\n\n  });\n\n  router.use((err, req, res, next) => {\n    console.error(err.stack);\n    res.status(500).send(err.stack);\n  });\n\n  // 携带变量出去\n  router._handlerParser = handlerParser;\n\n  return router;\n};\n"]}