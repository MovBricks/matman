{"version":3,"sources":["../../src/server/mixins.js"],"names":["shortid","require","pluralize","module","exports","getRemovable","createId","deepQuery","db","_","removable","each","coll","collName","doc","value","key","test","refName","plural","slice","ref","getById","isUndefined","push","name","id","idProperty","__id","isEmpty","maxBy","isFinite","generate","q","isArray","i","length","isObject","k","toString","toLowerCase","indexOf"],"mappings":";;AAAA,IAAMA,UAAUC,QAAQ,SAAR,CAAhB;AACA,IAAMC,YAAYD,QAAQ,WAAR,CAAlB;;AAEAE,OAAOC,OAAP,GAAiB;AACfC,4BADe;AAEfC,oBAFe;AAGfC;AAHe,CAAjB;;AAMA;AACA;AACA,SAASF,YAAT,CAAsBG,EAAtB,EAA0B;AACxB,MAAMC,IAAI,IAAV;AACA,MAAMC,YAAY,EAAlB;AACAD,IAAEE,IAAF,CAAOH,EAAP,EAAW,UAACI,IAAD,EAAOC,QAAP,EAAoB;AAC7BJ,MAAEE,IAAF,CAAOC,IAAP,EAAa,UAACE,GAAD,EAAS;AACpBL,QAAEE,IAAF,CAAOG,GAAP,EAAY,UAACC,KAAD,EAAQC,GAAR,EAAgB;AAC1B,YAAI,MAAMC,IAAN,CAAWD,GAAX,CAAJ,EAAqB;AACnB,cAAME,UAAUhB,UAAUiB,MAAV,CAAiBH,IAAII,KAAJ,CAAU,CAAV,EAAa,CAAC,CAAd,CAAjB,CAAhB;AACA;AACA,cAAIZ,GAAGU,OAAH,CAAJ,EAAiB;AACf;AACA,gBAAMG,MAAMZ,EAAEa,OAAF,CAAUd,GAAGU,OAAH,CAAV,EAAuBH,KAAvB,CAAZ;AACA,gBAAIN,EAAEc,WAAF,CAAcF,GAAd,CAAJ,EAAwB;AACtBX,wBAAUc,IAAV,CAAe,EAAEC,MAAMZ,QAAR,EAAkBa,IAAIZ,IAAIY,EAA1B,EAAf;AACD;AACF;AACF;AACF,OAZD;AAaD,KAdD;AAeD,GAhBD;;AAkBA,SAAOhB,SAAP;AACD;;AAED;AACA;AACA,SAASJ,QAAT,CAAkBM,IAAlB,EAAwB;AACtB,MAAMH,IAAI,IAAV;AACA,MAAMkB,aAAalB,EAAEmB,IAAF,EAAnB;AACA,MAAInB,EAAEoB,OAAF,CAAUjB,IAAV,CAAJ,EAAqB;AACnB,WAAO,CAAP;AACD,GAFD,MAEO;AACL,QAAIc,KAAKjB,EAAEG,IAAF,EAAQkB,KAAR,CAAcH,UAAd,EAA0BA,UAA1B,CAAT;;AAEA;AACA,WAAOlB,EAAEsB,QAAF,CAAWL,EAAX,IACH,EAAEA,EADC,GAEH1B,QAAQgC,QAAR,EAFJ;AAGD;AACF;;AAED,SAASzB,SAAT,CAAmBQ,KAAnB,EAA0BkB,CAA1B,EAA6B;AAC3B,MAAMxB,IAAI,IAAV;AACA,MAAIM,SAASkB,CAAb,EAAgB;AACd,QAAIxB,EAAEyB,OAAF,CAAUnB,KAAV,CAAJ,EAAsB;AACpB,WAAK,IAAIoB,IAAI,CAAb,EAAgBA,IAAIpB,MAAMqB,MAA1B,EAAkCD,GAAlC,EAAuC;AACrC,YAAI1B,EAAEF,SAAF,CAAYQ,MAAMoB,CAAN,CAAZ,EAAsBF,CAAtB,CAAJ,EAA8B;AAC5B,iBAAO,IAAP;AACD;AACF;AACF,KAND,MAMO,IAAIxB,EAAE4B,QAAF,CAAWtB,KAAX,KAAqB,CAACN,EAAEyB,OAAF,CAAUnB,KAAV,CAA1B,EAA4C;AACjD,WAAK,IAAIuB,CAAT,IAAcvB,KAAd,EAAqB;AACnB,YAAIN,EAAEF,SAAF,CAAYQ,MAAMuB,CAAN,CAAZ,EAAsBL,CAAtB,CAAJ,EAA8B;AAC5B,iBAAO,IAAP;AACD;AACF;AACF,KANM,MAMA,IAAIlB,MAAMwB,QAAN,GAAiBC,WAAjB,GAA+BC,OAA/B,CAAuCR,CAAvC,MAA8C,CAAC,CAAnD,EAAsD;AAC3D,aAAO,IAAP;AACD;AACF;AACF","file":"mixins.js","sourcesContent":["const shortid = require('shortid');\nconst pluralize = require('pluralize');\n\nmodule.exports = {\n  getRemovable,\n  createId,\n  deepQuery\n};\n\n// Returns document ids that have unsatisfied relations\n// Example: a comment that references a post that doesn't exist\nfunction getRemovable(db) {\n  const _ = this\n  const removable = []\n  _.each(db, (coll, collName) => {\n    _.each(coll, (doc) => {\n      _.each(doc, (value, key) => {\n        if (/Id$/.test(key)) {\n          const refName = pluralize.plural(key.slice(0, -2))\n          // Test if table exists\n          if (db[refName]) {\n            // Test if references is defined in table\n            const ref = _.getById(db[refName], value)\n            if (_.isUndefined(ref)) {\n              removable.push({ name: collName, id: doc.id })\n            }\n          }\n        }\n      })\n    })\n  });\n\n  return removable;\n}\n\n// Return incremented id or uuid\n// Used to override lodash-id's createId with utils.createId\nfunction createId(coll) {\n  const _ = this;\n  const idProperty = _.__id();\n  if (_.isEmpty(coll)) {\n    return 1\n  } else {\n    let id = _(coll).maxBy(idProperty)[idProperty]\n\n    // Increment integer id or generate string id\n    return _.isFinite(id)\n      ? ++id\n      : shortid.generate()\n  }\n}\n\nfunction deepQuery(value, q) {\n  const _ = this;\n  if (value && q) {\n    if (_.isArray(value)) {\n      for (let i = 0; i < value.length; i++) {\n        if (_.deepQuery(value[i], q)) {\n          return true\n        }\n      }\n    } else if (_.isObject(value) && !_.isArray(value)) {\n      for (let k in value) {\n        if (_.deepQuery(value[k], q)) {\n          return true\n        }\n      }\n    } else if (value.toString().toLowerCase().indexOf(q) !== -1) {\n      return true\n    }\n  }\n}\n"]}