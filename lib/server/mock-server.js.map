{"version":3,"sources":["../../src/server/mock-server.js"],"names":["fs","require","path","express","cors","compression","errorhandler","objectAssign","module","exports","opts","staticDir","join","__dirname","logger","static","arr","noGzip","push","noCors","origin","credentials","process","env","NODE_ENV","req","res","next","header","readOnly","method","sendStatus"],"mappings":";;AAAA,IAAMA,KAAKC,QAAQ,IAAR,CAAX;AACA,IAAMC,OAAOD,QAAQ,MAAR,CAAb;AACA,IAAME,UAAUF,QAAQ,SAAR,CAAhB;AACA;AACA,IAAMG,OAAOH,QAAQ,MAAR,CAAb;AACA,IAAMI,cAAcJ,QAAQ,aAAR,CAApB;AACA,IAAMK,eAAeL,QAAQ,cAAR,CAArB;AACA,IAAMM,eAAeN,QAAQ,eAAR,CAArB;;AAEAO,OAAOC,OAAP,GAAiB,UAAUC,IAAV,EAAgB;AAC/B;AACA;AACA;AACA;AACA;;AAEA,MAAMC,YAAYT,KAAKU,IAAL,CAAUC,SAAV,EAAqB,kBAArB,CAAlB;;AAEAH,SAAOH,aAAa,EAAEO,QAAQ,IAAV,EAAgBC,QAAQJ,SAAxB,EAAb,EAAkDD,IAAlD,CAAP;;AAEA,MAAMM,MAAM,EAAZ;;AAEA;AACA,MAAI,CAACN,KAAKO,MAAV,EAAkB;AAChBD,QAAIE,IAAJ,CAASb,aAAT;AACD;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,MAAI,CAACK,KAAKS,MAAV,EAAkB;AAChBH,QAAIE,IAAJ,CAASd,KAAK,EAAEgB,QAAQ,IAAV,EAAgBC,aAAa,IAA7B,EAAL,CAAT;AACD;;AAED,MAAIC,QAAQC,GAAR,CAAYC,QAAZ,KAAyB,aAA7B,EAA4C;AAC1C;AACAR,QAAIE,IAAJ,CAASZ,cAAT;AACD;;AAED;AACAU,MAAIE,IAAJ,CAASf,QAAQY,MAAR,CAAeL,KAAKK,MAApB,CAAT;;AAEA;AACA;AACAC,MAAIE,IAAJ,CAAS,UAACO,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAoB;AAC3BD,QAAIE,MAAJ,CAAW,eAAX,EAA4B,UAA5B;AACAF,QAAIE,MAAJ,CAAW,QAAX,EAAqB,UAArB;AACAF,QAAIE,MAAJ,CAAW,SAAX,EAAsB,IAAtB;AACAD;AACD,GALD;;AAOA;AACA,MAAIjB,KAAKmB,QAAT,EAAmB;AACjBb,QAAIE,IAAJ,CAAS,UAACO,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAoB;AAC3B,UAAIF,IAAIK,MAAJ,KAAe,KAAnB,EAA0B;AACxBH,eADwB,CAChB;AACT,OAFD,MAEO;AACLD,YAAIK,UAAJ,CAAe,GAAf,EADK,CACgB;AACtB;AACF,KAND;AAOD;;AAED,SAAOf,GAAP;AACD,CAhED","file":"mock-server.js","sourcesContent":["const fs = require('fs');\nconst path = require('path');\nconst express = require('express');\n// const logger = require('morgan');\nconst cors = require('cors');\nconst compression = require('compression');\nconst errorhandler = require('errorhandler');\nconst objectAssign = require('object-assign');\n\nmodule.exports = function (opts) {\n  // const userDir = path.join(process.cwd(), 'public');\n  // const defaultDir = path.join(__dirname, '../../www/static');\n  // const staticDir = fs.existsSync(userDir)\n  //   ? userDir\n  //   : defaultDir;\n\n  const staticDir = path.join(__dirname, '../../www/static');\n\n  opts = objectAssign({ logger: true, static: staticDir }, opts);\n\n  const arr = [];\n\n  // Compress all requests\n  if (!opts.noGzip) {\n    arr.push(compression());\n  }\n\n  // Logger，使用 log4js 来代替\n  // if (opts.logger) {\n  //   arr.push(\n  //     logger('dev', {\n  //       skip: (req) => (\n  //         process.env.NODE_ENV === 'test' ||\n  //         req.path === '/favicon.ico'\n  //       )\n  //     })\n  //   );\n  // }\n\n  // Enable CORS for all the requests, including static files\n  if (!opts.noCors) {\n    arr.push(cors({ origin: true, credentials: true }));\n  }\n\n  if (process.env.NODE_ENV === 'development') {\n    // only use in development\n    arr.push(errorhandler());\n  }\n\n  // Serve static files\n  arr.push(express.static(opts.static));\n\n  // No cache for IE\n  // https://support.microsoft.com/en-us/kb/234067\n  arr.push((req, res, next) => {\n    res.header('Cache-Control', 'no-cache');\n    res.header('Pragma', 'no-cache');\n    res.header('Expires', '-1');\n    next();\n  });\n\n  // Read-only\n  if (opts.readOnly) {\n    arr.push((req, res, next) => {\n      if (req.method === 'GET') {\n        next(); // Continue\n      } else {\n        res.sendStatus(403); // Forbidden\n      }\n    });\n  }\n\n  return arr;\n};\n"]}