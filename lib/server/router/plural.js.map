{"version":3,"sources":["../../../src/server/router/plural.js"],"names":["express","require","_","pluralize","write","getFullURL","utils","module","exports","db","name","router","Router","embed","resource","e","concat","forEach","externalResource","get","value","query","singularResource","singular","id","filter","expand","innerResource","plural","prop","getById","list","req","res","next","chain","q","_start","_end","_page","_sort","_order","_limit","_embed","_expand","arr","i","has","test","Array","isArray","toLowerCase","obj","key","deepQuery","element","map","isDifferent","isRange","isLike","path","replace","elementValue","undefined","isLowerThan","toString","RegExp","reduce","a","b","_sortSet","split","_orderSet","s","orderBy","setHeader","size","parseInt","page","getPage","links","fullURL","first","current","prev","last","items","slice","cloneDeep","locals","data","show","params","clone","create","insert","body","location","status","update","method","updateById","replaceById","destroy","removeById","removable","getRemovable","getState","item","w","route","post","put","patch","delete"],"mappings":"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","file":"plural.js","sourcesContent":["const express = require('express');\nconst _ = require('lodash');\nconst pluralize = require('pluralize');\nconst write = require('./write');\nconst getFullURL = require('./get-full-url');\nconst utils = require('../utils');\n\nmodule.exports = (db, name) => {\n  // Create router\n  const router = express.Router();\n\n  // Embed function used in GET /name and GET /name/id\n  function embed(resource, e) {\n    e && [].concat(e)\n      .forEach((externalResource) => {\n        if (db.get(externalResource).value) {\n          const query = {};\n          const singularResource = pluralize.singular(name);\n          query[`${singularResource}Id`] = resource.id;\n          resource[externalResource] = db.get(externalResource).filter(query).value()\n        }\n      })\n  }\n\n  // Expand function used in GET /name and GET /name/id\n  function expand(resource, e) {\n    e && [].concat(e)\n      .forEach((innerResource) => {\n        const plural = pluralize(innerResource);\n        if (db.get(plural).value()) {\n          const prop = `${innerResource}Id`;\n          resource[innerResource] = db.get(plural).getById(resource[prop]).value();\n        }\n      })\n  }\n\n  // GET /name\n  // GET /name?q=\n  // GET /name?attr=&attr=\n  // GET /name?_end=&\n  // GET /name?_start=&_end=&\n  // GET /name?_embed=&_expand=\n  function list(req, res, next) {\n    // Resource chain\n    let chain = db.get(name);\n\n    // Remove q, _start, _end, ... from req.query to avoid filtering using those\n    // parameters\n    let q = req.query.q;\n    let _start = req.query._start;\n    let _end = req.query._end;\n    let _page = req.query._page;\n    let _sort = req.query._sort;\n    let _order = req.query._order;\n    let _limit = req.query._limit;\n    let _embed = req.query._embed;\n    let _expand = req.query._expand;\n    delete req.query.q;\n    delete req.query._start;\n    delete req.query._end;\n    delete req.query._sort;\n    delete req.query._order;\n    delete req.query._limit;\n    delete req.query._embed;\n    delete req.query._expand;\n\n    // Automatically delete query parameters that can't be found\n    // in the database\n    Object.keys(req.query).forEach((query) => {\n      const arr = db.get(name).value()\n      for (let i in arr) {\n        if (\n          _.has(arr[i], query) ||\n          query === 'callback' ||\n          query === '_' ||\n          /_lte$/.test(query) ||\n          /_gte$/.test(query) ||\n          /_ne$/.test(query) ||\n          /_like$/.test(query)\n        ) return;\n      }\n      delete req.query[query];\n    });\n\n    if (q) {\n      // Full-text search\n      if (Array.isArray(q)) {\n        q = q[0];\n      }\n\n      q = q.toLowerCase();\n\n      chain = chain.filter((obj) => {\n        for (let key in obj) {\n          const value = obj[key];\n          if (db._.deepQuery(value, q)) {\n            return true;\n          }\n        }\n      })\n    }\n\n    Object.keys(req.query).forEach((key) => {\n      // Don't take into account JSONP query parameters\n      // jQuery adds a '_' query parameter too\n      if (key !== 'callback' && key !== '_') {\n        // Always use an array, in case req.query is an array\n        const arr = [].concat(req.query[key])\n\n        chain = chain.filter((element) => {\n          return arr\n            .map(function (value) {\n              const isDifferent = /_ne$/.test(key)\n              const isRange = /_lte$/.test(key) || /_gte$/.test(key)\n              const isLike = /_like$/.test(key)\n              const path = key.replace(/(_lte|_gte|_ne|_like)$/, '')\n              // get item value based on path\n              // i.e post.title -> 'foo'\n              const elementValue = _.get(element, path)\n\n              // Prevent toString() failing on undefined or null values\n              if (elementValue === undefined || elementValue === null) {\n                return\n              }\n\n              if (isRange) {\n                const isLowerThan = /_gte$/.test(key)\n\n                return isLowerThan\n                  ? value <= elementValue\n                  : value >= elementValue\n              } else if (isDifferent) {\n                return value !== elementValue.toString()\n              } else if (isLike) {\n                return new RegExp(value, 'i').test(elementValue.toString())\n              } else {\n                return value === elementValue.toString()\n              }\n            })\n            .reduce((a, b) => a || b)\n        })\n      }\n    })\n\n    // Sort\n    if (_sort) {\n      const _sortSet = _sort.split(',')\n      const _orderSet = (_order || '').split(',').map(s => s.toLowerCase())\n      chain = chain.orderBy(_sortSet, _orderSet)\n    }\n\n    // Slice result\n    if (_end || _limit || _page) {\n      res.setHeader('X-Total-Count', chain.size())\n      res.setHeader('Access-Control-Expose-Headers', 'X-Total-Count' + (_page ? ', Link' : ''))\n    }\n\n    if (_page) {\n      _page = parseInt(_page, 10)\n      _page = _page >= 1 ? _page : 1\n      _limit = parseInt(_limit, 10) || 10\n      const page = utils.getPage(chain.value(), _page, _limit)\n      const links = {}\n      const fullURL = getFullURL(req)\n\n      if (page.first) {\n        links.first = fullURL.replace('page=' + page.current, 'page=' + page.first)\n      }\n\n      if (page.prev) {\n        links.prev = fullURL.replace('page=' + page.current, 'page=' + page.prev)\n      }\n\n      if (page.next) {\n        links.next = fullURL.replace('page=' + page.current, 'page=' + page.next)\n      }\n\n      if (page.last) {\n        links.last = fullURL.replace('page=' + page.current, 'page=' + page.last)\n      }\n\n      res.links(links)\n      chain = _.chain(page.items)\n    } else if (_end) {\n      _start = parseInt(_start, 10) || 0\n      _end = parseInt(_end, 10)\n      chain = chain.slice(_start, _end)\n    } else if (_limit) {\n      _start = parseInt(_start, 10) || 0\n      _limit = parseInt(_limit, 10)\n      chain = chain.slice(_start, _start + _limit)\n    }\n\n    // embed and expand\n    chain = chain\n      .cloneDeep()\n      .forEach(function (element) {\n        embed(element, _embed)\n        expand(element, _expand)\n      })\n\n    res.locals.data = chain.value()\n    next()\n  }\n\n  // GET /name/:id\n  // GET /name/:id?_embed=&_expand\n  function show(req, res, next) {\n    const _embed = req.query._embed\n    const _expand = req.query._expand\n    const resource = db.get(name)\n      .getById(req.params.id)\n      .value()\n\n    if (resource) {\n      // Clone resource to avoid making changes to the underlying object\n      const clone = _.cloneDeep(resource)\n\n      // Embed other resources based on resource id\n      // /posts/1?_embed=comments\n      embed(clone, _embed)\n\n      // Expand inner resources based on id\n      // /posts/1?_expand=user\n      expand(clone, _expand)\n\n      res.locals.data = clone\n    }\n\n    next()\n  }\n\n  // POST /name\n  function create(req, res, next) {\n    const resource = db\n      .get(name)\n      .insert(req.body)\n      .value()\n\n    res.setHeader('Access-Control-Expose-Headers', 'Location')\n    res.location(`${getFullURL(req)}/${resource.id}`)\n\n    res.status(201)\n    res.locals.data = resource\n\n    next()\n  }\n\n  // PUT /name/:id\n  // PATCH /name/:id\n  function update(req, res, next) {\n    const id = req.params.id\n    let chain = db.get(name)\n\n    chain = req.method === 'PATCH'\n      ? chain.updateById(id, req.body)\n      : chain.replaceById(id, req.body)\n\n    const resource = chain.value()\n\n    if (resource) {\n      res.locals.data = resource\n    }\n\n    next()\n  }\n\n  // DELETE /name/:id\n  function destroy(req, res, next) {\n    const resource = db.get(name)\n      .removeById(req.params.id)\n      .value()\n\n    // Remove dependents documents\n    const removable = db._.getRemovable(db.getState())\n\n    removable.forEach((item) => {\n      db.get(item.name)\n        .removeById(item.id)\n        .value()\n    })\n\n    if (resource) {\n      res.locals.data = {}\n    }\n\n    next()\n  }\n\n  const w = write(db)\n\n  router.route('/')\n    .get(list)\n    .post(create, w)\n\n  router.route('/:id')\n    .get(show)\n    .put(update, w)\n    .patch(update, w)\n    .delete(destroy, w)\n\n  return router\n}\n"]}