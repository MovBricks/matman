{"version":3,"sources":["../../src/parser/handler-parser2.js"],"names":["fs","require","fse","_","path","marked","fsHandler","matmanCore","util","store","parserUtil","HandlerParser","entry","appHandlerPath","join","APP_PATH","HANDLERS_RELATIVE_PATH","srcHandlerPath","SRC_PATH","basePath","definedHandlers","dbPath","handleModulesFolderName","handlerConfigName","handleModuleConfigName","targetField","db","getDB","parseAndSave","allHandler","getAllHandler","setState","data","write","isReset","get","value","search","getAll","globs","forEach","item","isDirectory","name","basename","relativePath","serialize","relative","__dirname","indexOf","replace","push","console","error","log","handlerArr","handlerInfo","getHandler","handlerName","cacheData","find","curDefinedHandler","filter","config","handlerData","getMixinHandlerData","CUR_HANDLER_PATH","modules","handleModules","length","indexModule","description","priority","type","query","_m_target","existsSync","fileName","curHandleModuleData","getMixinHandleModuleData","activeModule","map","getHandlerByRoute","route","params","getMatchedHandler","getHandlerListByPlugin","pluginName","plugin","getHandleModule","handleModuleName","_getHandleModuleByHandler","getHandleModuleResultForHttp","req","reqInfoByRoute","getReqInfoByRoute","reject","handle","getTargetResult","requiredModule","then","extra","getHandleModuleResult","props","getModuleResult","fullPath","handleModuleInfo","moduleRelativePath","moduleFullPath","reqParams","merge","module","updateHandler","updateData","assign","getReadMeContent","curMockerPath","handlerReadMeFile","setOptions","renderer","Renderer","gfm","tables","breaks","pedantic","sanitize","smartLists","smartypants","content","readFileSync","e","stack","i","mockModuleItem"],"mappings":"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","file":"handler-parser2.js","sourcesContent":["const fs = require('fs');\nconst fse = require('fs-extra');\nconst _ = require('lodash');\nconst path = require('path');\nconst marked = require('marked');\nconst fsHandler = require('fs-handler');\nconst matmanCore = require('matman-core');\n\nconst util = require('../util');\nconst store = require('../store');\n\nconst parserUtil = require('./parser-util');\n\nexport default class HandlerParser {\n  constructor(entry) {\n    this.appHandlerPath = path.join(entry.APP_PATH, entry.HANDLERS_RELATIVE_PATH);\n    this.srcHandlerPath = path.join(entry.SRC_PATH, entry.HANDLERS_RELATIVE_PATH);\n    this.basePath = this.appHandlerPath;\n    this.definedHandlers = [...entry.definedHandlers];\n\n    this.dbPath = entry.APP_PATH;\n    this.handleModulesFolderName = 'handle_modules';\n    this.handlerConfigName = 'config.json';\n    this.handleModuleConfigName = 'config.json';\n    this.targetField = '_m_target';\n\n    // 注意此处一定要保证存储数据的地址是可存在的，否则会保存失败。\n    // fse.ensureDirSync(this.dbPath);\n\n    this.db = store.getDB(path.join(this.dbPath, 'db.json'));\n  }\n\n  /**\n   * 分析并保存数据到本地\n   */\n  parseAndSave() {\n    // 获取本地所有的 handler 列表。注意此处不能够取自缓存，要重新去分析。\n    let allHandler = this.getAllHandler(true);\n\n    // 存储到本地缓存数据文件内，以便下次启动时能够记录上一次的操作\n    this.db.setState({\n      basePath: this.basePath,\n      srcHandlerPath: this.srcHandlerPath,\n      appHandlerPath: this.appHandlerPath,\n      data: allHandler\n    }).write();\n\n    // 将结果返回\n    return allHandler;\n  }\n\n  /**\n   * 获取所有的 handler 信息\n   *\n   * @param {boolean} [isReset] 是否为重置，如果为true，则将忽略缓存数据\n   * @return {Array}\n   */\n  getAllHandler(isReset) {\n    // 默认情况下，handler列表的数据直接从缓存中获取，除非指定了 isReset=true。\n    if (!isReset) {\n      return this.db.get('data').value() || [];\n    }\n\n    // 1. 获取所有的 handler\n    fsHandler.search.getAll(this.basePath, { globs: ['*'] }).forEach((item) => {\n      /**\n       * 限制只处理文件夹类型的\n       * 在根目录下，每个子文件夹就是一个 handler 单位，其名字即为文件夹名字\n       */\n      if (item.isDirectory()) {\n        let name = path.basename(item.relativePath);\n\n        // 将模块进行序列化处理\n        matmanCore.serialize(path.join(this.srcHandlerPath, name), path.join(this.appHandlerPath, name));\n\n        // 获得相对路径，以便 require 到 definedHandlers 中\n        let relativePath = path.relative(__dirname, path.join(this.appHandlerPath, name));\n\n        // 当路径是 './' 开头时，这里的结果会将其省略，因此要再加回来，否则 require 时会先去 node_modules 寻找，就会产生问题\n        relativePath = relativePath.indexOf('..') > -1 ? relativePath : './' + relativePath;\n\n        // 需要将“\\”替换为“/”\n        relativePath = relativePath.replace(/\\\\/gi, '/');\n\n        // 把处理之后的模块加入到 definedHandlers 中\n        this.definedHandlers.push(require(relativePath));\n      } else {\n        // 正常情况下不允许在根目录下有非文件夹的存在，因此此处需要增加错误展示\n        console.error(`${path.join(item.basePath, item.relativePath)} SHOULD BE Directory!`);\n      }\n    });\n\n    // 打印一些结果\n    console.log(this.definedHandlers);\n\n    // 2. 根据 handler name 获取该 handler 下的所有 handle_modules\n    let handlerArr = [];\n\n    this.definedHandlers.forEach((item) => {\n      let handlerInfo = this.getHandler(item.name, true);\n\n      // 有可能该 handler 不合法，只有合法的 handler 才进行处理\n      if (handlerInfo) {\n        handlerArr.push(handlerInfo);\n      }\n    });\n\n    return handlerArr;\n  }\n\n  /**\n   * 通过名字获取 handler 的信息，当然包括 handle_modules 信息\n   *\n   * @param {String} handlerName 指定的 handler 的名字\n   * @param {Boolean} [isReset] 是否为重置，如果为true，则将忽略缓存数据\n   * @return {Object}\n   */\n  getHandler(handlerName, isReset) {\n    //===============================================================\n    // 1. 从缓存数据库中获取 handler 数据\n    //===============================================================\n    let cacheData = this.db.get('data').find({ name: handlerName }).value();\n\n    // 默认情况下，handler列表的数据直接从缓存中获取，除非指定了 isReset=true。\n    if (!isReset) {\n      return cacheData;\n    }\n\n    //===============================================================\n    // 2. 获取 definedHandler 信息\n    //===============================================================\n    let curDefinedHandler = this.definedHandlers.filter(item => item.name === handlerName)[0];\n    if (!curDefinedHandler || !curDefinedHandler.config) {\n      console.error(handlerName + ' invalid!', curDefinedHandler);\n      return null;\n    }\n\n    //===============================================================\n    // 3. 以一定的方式， 获取 handler 模块最终信息\n    //===============================================================\n    let handlerData = parserUtil.getMixinHandlerData(handlerName, curDefinedHandler.config, cacheData);\n\n    // TODO 如果匹配规则一模一样，需要进行警告提示！！！！！\n    if (!handlerData) {\n      return null;\n    }\n\n    //===============================================================\n    // 4. 获取当前的 handler 下的 handle_modules 列表，或者 index.js/index.json\n    //===============================================================\n    const CUR_HANDLER_PATH = path.join(this.basePath, handlerName);\n    let modules = [];\n\n    if (!curDefinedHandler.handleModules.length) {\n      // 如果没有 handle_modules 文件夹，则使用 index.js 或者 index.json，且将其设置为默认\n      let indexModule = {\n        name: 'index_module',\n        description: 'default module',\n        priority: 0,\n        type: 'noModule'\n      };\n\n      indexModule.query = { _m_target: indexModule.name };\n\n      if (fs.existsSync(path.join(CUR_HANDLER_PATH, 'index.js'))) {\n        indexModule.fileName = 'index.js';\n      } else if (fs.existsSync(path.join(CUR_HANDLER_PATH, 'index.json'))) {\n        indexModule.fileName = 'index.json';\n      } else {\n        return null;\n      }\n\n      modules.push(indexModule);\n\n    } else {\n      curDefinedHandler.handleModules.forEach((item) => {\n        // 获取最后处理之后的数据\n        let curHandleModuleData = parserUtil.getMixinHandleModuleData(item.name, item.config || {});\n\n        modules.push(curHandleModuleData);\n      });\n    }\n\n    // handle_modules 列表\n    handlerData.modules = modules;\n\n    //===============================================================\n    // 5. 其他默认处理\n    //===============================================================\n\n    // 如果不存在默认的 activeModule，或者存在默认的 activeModule，但是它是一个非法值，则设置第一个 handle_module 为默认\n    if ((!handlerData.activeModule || (modules.map(item => item.name).indexOf(handlerData.activeModule) < 0)) && modules.length) {\n      handlerData.activeModule = modules[0].name;\n    }\n\n    //===============================================================\n    // 6. 合并返回\n    //===============================================================\n\n    return handlerData;\n  }\n\n  /**\n   * 通过路由及请求参数获取 handler 的信息\n   *\n   * @param {String} route 路由规则\n   * @param {Object} [params] 请求的参数\n   * @return {Object}\n   */\n  getHandlerByRoute(route, params = {}) {\n    return parserUtil.getMatchedHandler(this.getAllHandler(), route, params);\n  }\n\n  /**\n   * 获取某个 plugin 所有的 handler 信息\n   *\n   * @param {String} [pluginName] 插件名字\n   * @return {Array}\n   */\n  getHandlerListByPlugin(pluginName = 'mocker') {\n    return this.db.get('data').filter({ plugin: pluginName }).value() || [];\n  }\n\n  /**\n   * 通过名字获取 handle_module 的信息\n   *\n   * @param {String} handlerName 指定的 handler 的名字\n   * @param {String} handleModuleName 指定的 handle_module 的名字\n   * @param {Boolean} [isReset] 是否为重置，如果为true，则将忽略缓存数据\n   * @return {Object}\n   */\n  getHandleModule(handlerName, handleModuleName, isReset) {\n    let handlerInfo = this.getHandler(handlerName, isReset);\n\n    return this._getHandleModuleByHandler(handlerInfo, handleModuleName);\n  }\n\n  /**\n   * 根据路由和请求参数，获得目标的执行结果，专为 http 请求\n   * @param {String} route 路由规则\n   * @param {Object} [params] 请求的参数\n   * @param {Object} [req] 请求对象\n   * @return {Promise}\n   */\n  getHandleModuleResultForHttp(route, params = {}, req) {\n    let reqInfoByRoute = this.getReqInfoByRoute(route, params);\n\n    if (!reqInfoByRoute) {\n      return Promise.reject('Could not get reqInfo by route=' + route + ' and params=' + JSON.stringify(params));\n    }\n\n    console.log('==reqInfoByRoute==', reqInfoByRoute);\n\n    return fsHandler.handle.getTargetResult(reqInfoByRoute.requiredModule, reqInfoByRoute.params, req)\n      .then((data) => {\n        return {\n          data: data,\n          extra: reqInfoByRoute\n        };\n      });\n  }\n\n  /**\n   * 根据路由，获得目标的执行结果\n   * @param {String} route 路由规则\n   * @param {Object} [params] 请求的参数\n   * @param props\n   * @return {Promise}\n   */\n  getHandleModuleResult(route, params, ...props) {\n    let reqInfoByRoute = this.getReqInfoByRoute(route, params);\n\n    if (!reqInfoByRoute) {\n      return Promise.reject();\n    }\n\n    return fsHandler.handle.getModuleResult(reqInfoByRoute.fullPath, params, ...props);\n  }\n\n  /**\n   * 通过路由匹配获取到本地模块路径和完整的请求信息\n   *\n   * @param {String} route 路由规则\n   * @param {Object} [params] 请求的参数\n   * @return {Object}\n   */\n  getReqInfoByRoute(route, params = {}) {\n    // 获得当前的 handler 信息\n    let handlerInfo = this.getHandlerByRoute(route, params);\n\n    if (!handlerInfo) {\n      return null;\n    }\n\n    // 优先获取 param 中请求的指定 handle_module，其次是 handerInfo.activeModule\n    let handleModuleName = params[this.targetField] || handlerInfo.activeModule;\n\n    let handleModuleInfo = this._getHandleModuleByHandler(handlerInfo, handleModuleName);\n\n    if (!handleModuleInfo) {\n      return null;\n    }\n\n    // 目标模块的路径，需要注意下 no module 的场景\n\n    let moduleRelativePath = (handleModuleInfo.type && handleModuleInfo.type === 'noModule') ? handleModuleInfo.fileName : path.join(this.handleModulesFolderName, handleModuleName);\n\n    let moduleFullPath = path.join(this.basePath, handlerInfo.name, moduleRelativePath);\n\n    // 还有部分参数在 handle_module 的 query 字段中，需要合并请求\n    let reqParams = _.merge({}, handleModuleInfo.query, params);\n\n    // TODO 此处还需要进一步优化\n    let requiredModule = this.definedHandlers.filter(item => item.name === handlerInfo.name)[0].handleModules.filter(item => item.name === handleModuleInfo.name)[0].module;\n\n    return {\n      handlerInfo: handlerInfo,\n      handleModuleInfo: handleModuleInfo,\n      fullPath: moduleFullPath,\n      params: reqParams,\n      requiredModule: requiredModule\n    };\n  }\n\n  /**\n   * 更新 handler 的 信息\n   *\n   * @param {String} handlerName handler 名字\n   * @param {Object} [updateData] 要更新的数据\n   */\n  updateHandler(handlerName, updateData) {\n    // 更新数据\n    this.db.get('data')\n      .find({ name: handlerName })\n      .assign(updateData)\n      .write();\n\n    // 返回新的结果\n    return this.getHandler(handlerName);\n  }\n\n  /**\n   * 获取指定 handler 的 README 信息\n   */\n  getReadMeContent(handlerName) {\n    let curMockerPath = path.join(this.basePath, handlerName);\n\n    let handlerReadMeFile = path.join(curMockerPath, 'readme.md');\n    if (!fs.existsSync(handlerReadMeFile)) {\n      handlerReadMeFile = path.join(curMockerPath, 'readme.MD');\n      if (!fs.existsSync(handlerReadMeFile)) {\n        handlerReadMeFile = path.join(curMockerPath, 'README.md');\n        if (!fs.existsSync(handlerReadMeFile)) {\n          handlerReadMeFile = path.join(curMockerPath, 'README.MD');\n          if (!fs.existsSync(handlerReadMeFile)) {\n            return '';\n          }\n        }\n      }\n    }\n\n    marked.setOptions({\n      renderer: new marked.Renderer(),\n      gfm: true,\n      tables: true,\n      breaks: false,\n      pedantic: false,\n      sanitize: false,\n      smartLists: true,\n      smartypants: false\n    });\n\n    try {\n      let content = fs.readFileSync(handlerReadMeFile, 'utf8');\n\n      content = content.replace(/__STATIC_PATH__/g, handlerName + '/static');\n\n      return marked(content);\n    } catch (e) {\n      return e.stack;\n    }\n  }\n\n  /**\n   * 从 handlerInfo 对象中获得指定的 handle_module 信息\n   *\n   * @param {Object} handlerInfo\n   * @param {String} handleModuleName\n   * @return {Object}\n   * @private\n   */\n  _getHandleModuleByHandler(handlerInfo, handleModuleName) {\n    if (!handlerInfo || !handlerInfo.modules || !handlerInfo.modules.length || !handleModuleName) {\n      return null;\n    }\n\n    let handleModuleInfo = null;\n\n    for (let i = 0, length = handlerInfo.modules.length; i < length; i++) {\n      let mockModuleItem = handlerInfo.modules[i];\n\n      if (handleModuleName === mockModuleItem.name) {\n        handleModuleInfo = mockModuleItem;\n        break;\n      }\n    }\n\n    return handleModuleInfo;\n  }\n}"]}